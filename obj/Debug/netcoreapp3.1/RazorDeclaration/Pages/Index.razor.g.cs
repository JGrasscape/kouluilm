#pragma checksum "C:\temp\Ohjelmistoprojekti\kouluilm\Pages\Index.razor" "{ff1816ec-aa5e-4d10-87f7-6f4963833460}" "a99398c591ea3d6d1514d4fc71e05dfe7f3c3c64"
// <auto-generated/>
#pragma warning disable 1591
#pragma warning disable 0414
#pragma warning disable 0649
#pragma warning disable 0169

namespace kouluilm.Pages
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Components;
#nullable restore
#line 1 "C:\temp\Ohjelmistoprojekti\kouluilm\_Imports.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "C:\temp\Ohjelmistoprojekti\kouluilm\_Imports.razor"
using Microsoft.AspNetCore.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "C:\temp\Ohjelmistoprojekti\kouluilm\_Imports.razor"
using Microsoft.AspNetCore.Components.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "C:\temp\Ohjelmistoprojekti\kouluilm\_Imports.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "C:\temp\Ohjelmistoprojekti\kouluilm\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "C:\temp\Ohjelmistoprojekti\kouluilm\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "C:\temp\Ohjelmistoprojekti\kouluilm\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "C:\temp\Ohjelmistoprojekti\kouluilm\_Imports.razor"
using kouluilm;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "C:\temp\Ohjelmistoprojekti\kouluilm\_Imports.razor"
using kouluilm.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "C:\temp\Ohjelmistoprojekti\kouluilm\_Imports.razor"
using kouluilm.Data;

#line default
#line hidden
#nullable disable
    [Microsoft.AspNetCore.Components.RouteAttribute("/")]
    public partial class Index : Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
        }
        #pragma warning restore 1998
#nullable restore
#line 219 "C:\temp\Ohjelmistoprojekti\kouluilm\Pages\Index.razor"
       
    // TODO:
    // Ilmoittautuminen
    // Ilmoittautumisen poisto
    // Näytä menneet koulutukset
    private Koulutus koulutus = new Koulutus();
    private List<Koulutus> koulutukset;
    private Resurssi resurssi = new Resurssi();
    private List<Resurssi> resurssit;
    private List<Varaus> varaukset;
    private List<Ilmoittautuminen> ilmoittautumiset;
    private Ilmoittautuminen ilmo = new Ilmoittautuminen();
    private string selite = "", ilmoMessu = "";
    private bool naytaOsallistujat = false, naytaOsallistujatModal = false, ilmoittauduDisabled = false, naytaKaavake = false;
    //private int valittuVaraus = 0;

    private async void naytaOsallistujatFunc(int varaus_id, int osallistujaLkm, int paikkaLkm)
    {          
        // Haetaan ilmoittautujat   
        ilmoittautumiset = await IlmoittautuminenService.GetOsallistujatAsync(varaus_id);

        // Mahtuuko mukaan?
        if (osallistujaLkm < paikkaLkm)
        {
            ilmoittauduDisabled = false;
        }
        else
        {
            ilmoittauduDisabled = true;
        }

        // Taulukko osallistujista
        //naytaOsallistujat = !naytaOsallistujat;

        // Modal osallistujista
        naytaOsallistujatModal = true;
        //valittuVaraus = varaus_id;
        ilmo.Linkki_Varaus_ID = varaus_id;
    }

    void OsallistujatPeruuta() => naytaOsallistujatModal = false;
    void Ilmoittaudu() => naytaKaavake = true;

    void KaavakePeruuta()
    {
        naytaKaavake = false;
        ilmoMessu = "";
        ilmo = new Ilmoittautuminen();
    }
    void KaavakeOK()
    {
        // Tarkastetaan syötetyt kentät
        if (string.IsNullOrWhiteSpace(ilmo.Nimi))
        {            
            ilmoMessu = "Anna ilmoittautujan nimi!";
            return;
        }
        else if (string.IsNullOrWhiteSpace(ilmo.Yksikko))
        {            
            ilmoMessu = "Anna ilmoittautujan yksikkö!";
            return;
        }
        else if (string.IsNullOrWhiteSpace(ilmo.Puh))
        {            
            ilmoMessu = "Anna ilmoittautujan puhnro!";
            return;
        }        

        IlmoittautuminenService.InsertOsallistujaAsync(ilmo);

        // Piilotetaan dialogi ja haetaan ilmoittautumiset
        ilmoMessu = "";
        ilmo = new Ilmoittautuminen();
        naytaKaavake = false;
        // TODO: Jatka
        //koulutukset = await KoulutusService.GetKoulutusAsync("IN (0, 1)");  
        //koulutus = new Koulutus();
        //uusiKoulutus = new Koulutus();
    }

    protected override async Task OnInitializedAsync()
    {
        // Haetaan koulutukset ja resurssit
        // TODO: Hae vain tulevat
        // TODO: Oma metodi myös menneille koulutuksille
        koulutukset = await KoulutusService.GetKoulutusAsync("=0");
        resurssit = await ResurssiService.GetResurssiAsync();
    }

    private async Task koulutusMuutos(string value)
    {
        // Valitaan kyseinen koulutus-olio listalta
        koulutus = koulutukset.Single(k => k.Koulutus_ID == value);
        selite = koulutus.Selite;

        // Haetaan tilavaraukset asiasanojen mukaisesti valitulle koulutukselle
        // Pilkotaan ensin asia- ja kieltosanat
        string sql = "";
        string[] sanat = koulutus.Asiasanat.Split(' ');

        foreach (string sana in sanat)
        {
            sql += " AND aihe LIKE '%" + sana + "%'";
        }

        if (koulutus.Kieltosanat != null)
        {
            sanat = koulutus.Kieltosanat.Split(' ');
            foreach (string sana in sanat)
            {
                sql += " AND aihe NOT LIKE '%" + sana + "%'";
            }
        }

        // Koulutuksiin käytettävät resurssit
        string sql2 = "";

        foreach (Resurssi r in resurssit)
        {
            sql2 += r.Resurssi_ID.ToString() + ", ";
        }

        // TODO: tarkista haetaanko vain tulevat koulutukset        

        // Haetaan tilavaraukset
        //varaukset = await VarausService.GetVarausAsync(sql, sql2, int.Parse(koulutus.Koulutus_ID));
        varaukset = await VarausService.GetVarausAsync(sql, sql2);

        foreach (Varaus v in varaukset)
        {
            // Lasketaan ilmoittautuneet ja talletetaan olioon
            v.Osallistujat = await IlmoittautuminenService.GetOsallistujatCountAsync(v.Varaus_ID);
        }

        //return Task.CompletedTask;
    }

#line default
#line hidden
#nullable disable
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IlmoittautuminenService IlmoittautuminenService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private VarausService VarausService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private ResurssiService ResurssiService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private KoulutusService KoulutusService { get; set; }
    }
}
#pragma warning restore 1591
